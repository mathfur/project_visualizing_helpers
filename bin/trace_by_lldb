#!/usr/bin/env python

import lldb
import os
import pprint
from optparse import OptionParser, OptionValueError

import lib.python.lldb_helper as helper

pp = pprint.PrettyPrinter(2)

usage = """
usage: %prog mode ruby_bin ruby_target_file

mode:              show_current_fname, list_all_literals, print_ruby_eval_tree
ruby_bin:          debug built ruby bin file path
ruby_target_file:  target ruby source file path
"""
parser = OptionParser(usage)

(options, args) = parser.parse_args()

if not args or len(args) != 3:
  parser.error("require mode, ruby_bin and target_ruby_file")
  parser.print_help()
  exit()

mode = args[0]
ruby_bin = args[1]
ruby_target_file = args[2]

if not os.path.exists(ruby_bin):
  parser.error("ruby_bin file `%s` is not exist" % ruby_bin)
  parser.print_help()
  exit()

if not os.path.exists(ruby_target_file):
  parser.error("ruby targate file `%s` is not exist" % ruby_target_file)
  parser.print_help()
  exit()

if not mode in ['show_current_fname', 'list_all_literals', 'print_ruby_eval_tree']:
  parser.error("require mode, ruby_bin and target_ruby_file")
  parser.print_help()
  exit()

#-----------------------------------------------

debugger = lldb.SBDebugger.Create()
debugger.SetAsync (False)

target = debugger.CreateTargetWithFileAndArch(ruby_bin, lldb.LLDB_ARCH_DEFAULT)
res = lldb.SBCommandReturnObject()

if target:
  h = helper.LLDBFrame(target, None, None)

  if mode == 'show_current_fname':
    bp = target.BreakpointCreateByName("rb_call", target.GetExecutable().GetFilename());

    bp.SetCondition("argc > 1")

    process = target.LaunchSimple([ruby_target_file], None, os.getcwd())
    if process:
      while True:
        state = process.GetState()
        if state == lldb.eStateStopped:
          thread = process.GetThreadAtIndex(0)
          if thread:
            frame = thread.GetFrameAtIndex(0)
            h = helper.LLDBFrame(target, process, frame)
            print "current_fname = %s;" % h.current_fname()
            process.Continue()
        else:
          break

  elif mode == 'list_all_literals':
    bp = target.BreakpointCreateByName("ruby_run", target.GetExecutable().GetFilename());

    process = target.LaunchSimple ([ruby_target_file], None, os.getcwd())
    if process:
      state = process.GetState ()
      if state == lldb.eStateStopped:
        thread = process.GetThreadAtIndex (0)
        if thread:
          frame = thread.GetFrameAtIndex (0)
          h = helper.LLDBFrame(target, process, frame)
          function = frame.GetFunction()
          if function:
            ruby_eval_tree = frame.EvaluateExpression('(NODE *) ruby_eval_tree')
            node_dic = h.inspect_node(ruby_eval_tree)
            for literal in h.find_all_literals(node_dic):
              print literal

  elif mode == 'print_ruby_eval_tree':
    target.BreakpointCreateByName("ruby_run", target.GetExecutable().GetFilename());

    process = target.LaunchSimple ([ruby_target_file], None, os.getcwd())
    if process:
        state = process.GetState ()
        if state == lldb.eStateStopped:
            thread = process.GetThreadAtIndex (0)
            if thread:
                frame = thread.GetFrameAtIndex (0)
                h = helper.LLDBFrame(target, process, frame)
                ruby_eval_tree = frame.EvaluateExpression('(NODE *) ruby_eval_tree')
                print h.inspect_node(ruby_eval_tree)
