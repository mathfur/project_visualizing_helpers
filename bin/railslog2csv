#!/usr/bin/env ruby
# encoding: utf-8

$: << (File.dirname(__FILE__) + "/..")

require 'getoptlong'
require 'lib/project_visualizing_helpers'

usage = <<EOS
Usage: railslog2csv [file]
EOS

opts = GetoptLong.new(
  ['--help', '-h', GetoptLong::NO_ARGUMENT],
  ['--version', '-v', GetoptLong::NO_ARGUMENT]
)

begin
  opts.each do |opt, arg|
    case opt
    when '--help'; puts usage; exit
    when '--version'; puts Railslog2CSV::VERSION; exit
    end
  end
rescue StandardError => e
  puts "wrong option" + e.inspect
  exit
end

ProjectVisualizingHelpers::Railslog2CSV.new(ARGF.read).result(
        :controller, :action, :time, :method, :param,
        :response_time, :view_time, :db_time, :response_code,
        :response_status, :url).each do |line|
  puts line.map{|e| '"' + (e || '').gsub('"', '\\"') + '"' }.join(",")
end
